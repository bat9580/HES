{% extends "base.html" %}
{% block content %}
{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %} 
<div class="p-4">
  <h2 class="mb-4">‚ö° Meter Management</h2>

  <form method = "GET" action = "/search-meter" class="row g-2 mb-3">
    <div class="col-md-2">
      <input type="text" class="form-control" placeholder="Meter No." name="meter_number" value="{{ meter_number | default('') }}">  
    </div>
    <div class="col-md-2">
      <select class="form-select">
        <option>Status</option>
        <option>Installed</option>
        <option>Archived</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select">
        <option value="">type</option>
        <option value="DTS545S">DTS545S</option> 
        <option value="DDSY283SR">DDSY283SR</option>   
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="device_type">
        <option value="">Device type</option> 
        <option value="GPRS Meter">GPRS Meter</option>
        <option value="PLC Meter">PLC Meter</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Search</button>
    </div>

    <div class="col-md-2">
        <button type="button" class="btn btn-dark w-100" data-bs-toggle="modal" data-bs-target="#addMeterModal">
            + Add
        </button>
    </div>
  </form>

  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Meter No.</th>
        <th>Comm Addr</th>
        <th>Meter Type</th>
        <th>Device Type</th>
        <th>remarks</th>
        <th>Create By</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for meter in registered_meters %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ meter['meter_number'] }}</td>
        <td>{{ meter['com_address'] }}</td>
        <td>{{ meter['type'] }}</td>
        <td>{{ meter['device_type'] }}</td>
        <td>{{ meter['remarks'] or '-' }}</td>
        <td>{{ meter['created_by'] }}</td>
        <td>
          {% if meter['status'] == 'Installed' %}
            <span class="badge bg-warning text-dark">Installed</span>
          {% elif meter['status'] == 'Archived' %}
            <span class="badge bg-secondary">Archived</span>
          {% else %}
            <span class="badge bg-light text-muted">Unknown</span>
          {% endif %}
        </td>
        <td>
          <button class="btn btn-sm btn-warning" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editMeterModal" 
                  data-original-meter-number="{{meter['meter_number']}}"  
                  data-meter-number="{{meter['meter_number']}}"
                  data-comm-address="{{ meter['com_address'] }}"
                  data-device-type="{{ meter['device_type'] }}"
                  data-type="{{ meter['type'] }}"
                  data-password="{{ meter['password'] }}"
                  data-remarks="{{ meter['remarks'] }}"
                  data-status="{{ meter['status'] }}"> 
            ‚úèÔ∏è Edit
          </button> 
          <!-- <button class="btn btn-sm btn-danger">üóëÔ∏è Delete</button> -->
          <form method="POST" action="/delete-meter" style="display:inline;" onsubmit="return confirmDelete();">  
            <input type="hidden" name="meter_number" value="{{ meter['meter_number'] }}"> 
            <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- add button form for meter adding  -->
 

<div class="modal fade" id="addMeterModal" tabindex="-1" aria-labelledby="addMeterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addMeterModalLabel">Add Meter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addMeterForm" method = "Post" action = "/add-meter">  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety-tab" data-bs-toggle="tab" data-bs-target="#safety" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail" role="tabpanel">
              
                
   
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select" name="device_type"  required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>* Meter No.</label>
                    <input type="text" name="meter_number" class="form-control" required> 
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>* Type</label>
                    <select class="form-select" name="type" required> 
                      <option>DDSY283SR</option>
                      <option>DTSD545S</option> 
                      
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Status</label>
                    <input type="text" name="status" class="form-control"  value="Archived" readonly> 
                  </div>
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" class="form-control">
                  </div>
                </div>
  
  
              
            </div>
  
            <div class="tab-pane fade" id="safety" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" class="form-control" required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="addMeterForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

  

  <!-- edit meter form for meter edit --> 
  <div class="modal fade" id="editMeterModal" tabindex="-1" aria-labelledby="editMeterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addMeterModalLabel">Edit Meter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editMeterForm" method = "Post" action = "/edit-meter">   
            <input type="hidden" name="original_meter_number" id="OriginalMeterNumber">  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail1-tab" data-bs-toggle="tab" data-bs-target="#detail1" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety1-tab" data-bs-toggle="tab" data-bs-target="#safety1" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail1" role="tabpanel">
              
   
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select" name="device_type" id = "editDeviceType" required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>* Meter No.</label>
                    <input type="text" name="meter_number" id = "editMeterNumber" class="form-control" required> 
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" id = "editCommAddress" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>* Type</label>
                    <select class="form-select" name="type" id = "editType" required> 
                      <option>DDSY283SR</option>
                      <option>DTSD545S</option> 
                      
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Status</label>
                    <input type="text" name="status" class="form-control"  value="Archived" readonly> 
                  </div>
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" id = "editRemarks" class="form-control">
                  </div>
                </div>
  
  
              
            </div>
  
            <div class="tab-pane fade" id="safety1" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" id = "editPassword" class="form-control" required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="editMeterForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>
 
  <script>
    const editModal = document.getElementById('editMeterModal');
    editModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;

      document.getElementById('OriginalMeterNumber').value = button.getAttribute('data-meter-number'); 
      document.getElementById('editMeterNumber').value = button.getAttribute('data-meter-number');
      document.getElementById('editCommAddress').value = button.getAttribute('data-comm-address');
      document.getElementById('editDeviceType').value = button.getAttribute('data-device-type');
      document.getElementById('editType').value = button.getAttribute('data-type');
      document.getElementById('editPassword').value = button.getAttribute('data-password');
      document.getElementById('editRemarks').value = button.getAttribute('data-remarks');
    });
    function confirmDelete(){
      return confirm("‚ö†Ô∏è Are you sure you want to delete this meter?");
    }
  </script>


{% endblock %}
