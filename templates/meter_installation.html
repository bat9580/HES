{% extends "base.html" %}
{% block content %}
{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %} 
<div class="p-4">
  <h4 class="mb-4">⚡Суулгасан тоолуурууд</h4>

  <form method = "GET" action = "/search-meter-installation" class="row g-1 mb-1">
    <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 name="meter_number"
                 placeholder="Тоолуур хайх"
                 value="{{ meter_number | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
          <span class="dropdown-chevron position-absolute end-0 top-50 translate-middle-y me-2">
            <svg width="25" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </div>
        
        <ul id="installed-meter-list" 
            class="dropdown-menu w-100"
            aria-labelledby="deviceDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
        </ul>
        <input type="hidden" name="device_type" required>
      </div>
    </div>
    

    <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <!-- Search Input + Dropdown Toggle Combined -->
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 placeholder="Бүлэг хайх"
                 name = "Zone"  
                 value="{{ Zone | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
          <span class="dropdown-chevron position-absolute end-0 top-50 translate-middle-y me-2">
            <svg width="25" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </div>
        
        <!-- Dropdown Menu (unchanged) -->
        <ul class="dropdown-menu w-100"
            aria-labelledby="zoneDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
        </ul>
        <input type="hidden" name="region" required>
      </div>
    </div>
    <div class="col-md-auto" style="width: 22.8%;">
      <div class="dropdown" style="height: 35px;">
        <!-- Search Input + Dropdown Toggle Combined -->
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 placeholder="Дэд станц"
                 name = "station"
                 value="{{ station | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
          <span class="dropdown-chevron position-absolute end-0 top-50 translate-middle-y me-2">
            <svg width="25" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </div>
        
        <!-- Dropdown Menu (unchanged) -->
        <ul class="dropdown-menu w-100"
            aria-labelledby="stationDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
        </ul>
        <input type="hidden" name="device_type" required>
      </div>

    </div>
    <div class="col-md-auto" style="width: 22.8%;">
      <div class="dropdown" style="height: 35px;">
        <!-- Search Input + Dropdown Toggle Combined -->
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 placeholder="DCU" 
                 name = "DCU"
                 value="{{ DCU | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
          <span class="dropdown-chevron position-absolute end-0 top-50 translate-middle-y me-2">
            <svg width="25" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </div>
        
        <!-- Dropdown Menu (unchanged) -->
        <ul class="dropdown-menu w-100"
            aria-labelledby="dcuDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
        </ul>
        <input type="hidden" name="device_type" required>
      </div>
    </div>
    <div class="col-md-auto" style="width: 4.166666%;">
      <button type="submit" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" > 
        <i class="bi bi-search"></i> 
      </button>
    </div>

    <div class="col-md-auto" style="width: 4.166666%;"> 
        <button type="button" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" data-bs-toggle="modal" data-bs-target="#addMeterModal">
          <i class="bi bi-plus-lg"></i>
        </button>
    </div>
    <div class="col-md-auto" style="width: 4.166666%;"> 
        <button type="button" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" data-bs-toggle="modal" data-bs-target="#uninstallMeterModal">
          <i class="bi bi-dash-lg"></i>
        </button>
    </div>
  </form>

  <table class="table table-bordered">
    <thead class="table-light">
      <tr style = "height: 30px;">
        <th style="width: 30px;">#</th>
        <th>Meter No.</th>
        <th>Comm Addr</th>
        <th>CT ratio</th>
        <th>VT_ratio</th> 
        <th>remarks</th>
        <th>line</th>
        <th>Status</th>
        <th>Operation</th>
      </tr>
    </thead>
    <tbody>
      {% for meter in installed_meters %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ meter['meter_number'] }}</td>
        <td>{{ meter['com_address'] }}</td>
        <td>{{ meter['CT_ratio'] }}</td>
        <td>{{ meter['VT_ratio'] }}</td>
        <td>{{ meter['remarks'] or '-' }}</td>
        <td>{{ meter['line'] }}</td>
        <td>
          {% if meter['status'] == 'installed' %}
            <span class="badge bg-success text-white">Installed</span>
          {% elif meter['status'] == 'Archived' %}
            <span class="badge bg-secondary">Archived</span>
          {% else %}
            <span class="badge bg-light text-muted">Unknown</span>
          {% endif %}
        </td>
        <td>
          <button class="btn btn-sm btn-secondary" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editMeterModal" 
                  data-original-meter-number="{{meter['meter_number']}}"  
                  data-meter-number="{{meter['meter_number']}}"
                  data-comm-address="{{ meter['com_address'] }}"
                  data-device-type="{{ meter['device_type'] }}"
                  data-type="{{ meter['type'] }}"
                  data-password="{{ meter['password'] }}"
                  data-remarks="{{ meter['remarks'] }}"
                  data-task="{{ meter['task'] }}"
                  data-status="{{ meter['status'] }}" 
                  data-vt_ratio = "{{ meter['VT_ratio'] }}"
                  data-ct_ratio = "{{ meter['CT_ratio'] }}"  
                  data-line="{{ meter['line'] }}">  
                  <i class="bi bi-pencil-square"> Edit</i> 
          </button> 
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- add button form for meter adding  -->
 

<div class="modal fade" id="addMeterModal" tabindex="-1" aria-labelledby="addMeterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addMeterModalLabel">Add Meter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addMeterForm" method = "Post" action = "/install-meter">  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety-tab" data-bs-toggle="tab" data-bs-target="#safety" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail" role="tabpanel">
              
                
   
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select custom-select" name="meter_type" required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <div class="dropdown">  
                      <div class="dropdown-toggle-wrapper position-relative">
                        <label>* Meter No.</label>
                        <input type="text" name="meter_number" class="form-control dropdown-search-input dimmed-text hoverable-input" readonly  required>
                      </div>
                        <ul class="dropdown-menu w-100"
                            aria-labelledby="archivedDropdown"
                            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
                        </ul>
                        <input type="hidden" name="device_type" required>
                    </div>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" class="form-control" readonly  required>
                  </div>
                  <div class="col-md-6">
                    <label>Meter Type</label>
                    <select class="form-select custom-select" name="modem_type" required> 
                      <option>DDSY283</option>
                      <option>DTSD545S</option> 
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>CT ratio</label> 
                    <input type="number" name="CT_ratio" class="form-control" step="1" min="0">
                  </div> 
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" class="form-control" readonly >
                  </div>
                </div>
                <div class="row mb-3">

                <div class="col-md-6">
                    <label>VT ratio</label> 
                    <input type="number" name="VT_ratio" class="form-control" step="1" min="0">
                  </div> 
                <div class="col-md-auto" id="parentNodeWrapper" style="display:block;">
                        <label>Харьяа шугам</label>
                        <div id="parentNodeTree"></div>
                        <input type="hidden" name="line" id="parent_node_input">
                </div> 
                </div>

            </div>
  
            <div class="tab-pane fade" id="safety" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" class="form-control" readonly required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="addMeterForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>
 <!-- meter uninstall hiih form --> 
  <div class="modal fade" id="uninstallMeterModal" tabindex="-1" aria-labelledby="uninstallMeterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uninstallMeterModalLabel">Dismantle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="uninstallMeterForm" method="POST" action="/uninstall-meter">
          <h6 class="mb-3 border-bottom pb-2">Meter Basic Information</h6>

          <div class="mb-3 row align-items-center">
            
                  <label class="col-sm-3 col-form-label fw-bold">* Meter No.</label> 
                   <div class="col-sm-9">
                    <div class="dropdown">  
                      <div class="dropdown-toggle-wrapper position-relative">
                        <input type="text" name="meter_number" class="form-control dropdown-search-input dimmed-text hoverable-input" required>
                      </div>
                        <ul class="dropdown-menu w-100"
                            aria-labelledby="installedDropdown"
                            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
                        </ul>
                        <input type="hidden" name="device_type" required>
                    </div>
                  </div>
          </div>

          <div class="mb-3 row align-items-center">
            <label class="col-sm-3 col-form-label fw-bold">Comm Addr</label>
            <div class="col-sm-9">
              <input type="text" name="comm_address" class="form-control">
            </div>
          </div>

          <div class="mb-3 row align-items-center">
            <label class="col-sm-3 col-form-label fw-bold">Type</label>
            <div class="col-sm-9">
              <select class="form-select" name="type" required>
                <option>DDSY283</option>
                <option>DTSD545S</option>
              </select>
            </div>
          </div>

          <div class="mb-3 row align-items-center">
            <label class="col-sm-3 col-form-label fw-bold">Status</label>
            <div class="col-sm-9">
              <input type="text" name="status" class="form-control" value="Archived" readonly>
            </div>
          </div>

          <div class="mb-3 row align-items-center">
            <label class="col-sm-3 col-form-label fw-bold">Remarks</label>
            <div class="col-sm-9">
              <textarea name="remarks" class="form-control" rows="2"></textarea>
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="uninstallMeterForm" class="btn btn-primary">Dismantle</button>
      </div>
    </div>
  </div>
</div>

  <!-- edit meter form for meter edit --> 
  <div class="modal fade" id="editMeterModal" tabindex="-1" aria-labelledby="editMeterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addMeterModalLabel">Edit Meter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editMeterForm" method = "Post" action = "/edit-meter-installation">   
            <input type="hidden" name="original_meter_number" id="OriginalMeterNumber">  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail1-tab" data-bs-toggle="tab" data-bs-target="#detail1" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety1-tab" data-bs-toggle="tab" data-bs-target="#safety1" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail1" role="tabpanel">
              
   
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select" name="device_type" id = "editDeviceType" required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>* Meter No.</label>
                    <input type="text" name="meter_number" id = "editMeterNumber" class="form-control" required> 
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" id = "editCommAddress" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>* Type</label> 
                    <select class="form-select" name="type" id = "editType" required> 
                      <option>DDSY283SR</option>
                      <option>DTSD545S</option> 
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>CT ratio</label> 
                    <input type="number" name="CT_ratio" id = "editCT_ratio" class="form-control" step="1" min="0">
                  </div> 
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" id = "editRemarks" class="form-control" readonly>  
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>VT ratio</label> 
                    <input type="number" name="VT_ratio" id = "editVT_ratio" class="form-control" step="1" min="0">
                  </div> 
                  <div class="col-md-auto" id="editLineWrapper" style="display:block;"> 
                    <label>Харьяа шугам</label>
                    <div id="editLineTree"></div>
                    <input type="hidden" name="line" id="edit_line_input">
                  </div> 
                </div>
  
              
            </div>
  
            <div class="tab-pane fade" id="safety1" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" id = "editPassword" class="form-control" required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="editMeterForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>
 
  <script>
    const editModal = document.getElementById('editMeterModal');
    editModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;

      document.getElementById('OriginalMeterNumber').value = button.getAttribute('data-meter-number'); 
      document.getElementById('editMeterNumber').value = button.getAttribute('data-meter-number');
      document.getElementById('editCommAddress').value = button.getAttribute('data-comm-address');
      document.getElementById('editDeviceType').value = button.getAttribute('data-device-type');
      document.getElementById('editType').value = button.getAttribute('data-type');
      document.getElementById('editPassword').value = button.getAttribute('data-password');
      document.getElementById('editRemarks').value = button.getAttribute('data-remarks'); 
      document.getElementById('editVT_ratio').value = button.getAttribute('data-vt_ratio');
      document.getElementById('editCT_ratio').value = button.getAttribute('data-ct_ratio'); 
      console.log(button.getAttribute('data-device-type'))
 

      const LineName = button.getAttribute('data-line'); 
      document.getElementById('edit_line_input').value = LineName || ''; 

      $('#editLineTree').on('loaded.jstree', function () {
        if (LineName) {
            // Find the node by its text
            const allLines = $('#editLineTree').jstree(true).get_json('#', { flat: true });
            const match = allLines.find(line => line.text === LineName); 

            if (match) {
                $('#editLineTree').jstree('select_line', match.id);
            }
        }
    });

    // (Re)initialize your jsTree if needed
    $('#editLineTree').jstree({
        core: {
            data: {
            url: '/line-tree-data',
            dataType: 'json'
            }
        }
    });

    // Update hidden input when user selects a node
    $('#editLineTree').on("changed.jstree", function (e, data) {
        if (data.selected.length) {
            const lineText = data.instance.get_node(data.selected[0]).text;
            document.getElementById('edit_line_input').value = lineText;
        } else {
            document.getElementById('edit_line_input').value = '';
        }
    }); 


      // $('#editLineTree').on("changed.jstree", function (e, data) {
      //     if (data && data.selected && data.selected.length > 0) {
      //         // Get the selected node's text (name)
      //         let selectedNodeName = data.instance.get_node(data.selected[0]).text;
              
      //         // Set hidden input value
      //         document.getElementById('edit_line_input').value = selectedNodeName;
      //     } else {
      //         document.getElementById('edit_line_input').value = '';
      //     }
      // }); 

    });


    

document.addEventListener('DOMContentLoaded', function() {
  const dropdowns = document.querySelectorAll('.dropdown');  
  dropdowns.forEach(function(dropdown) {
    const searchInput = dropdown.querySelector('.dropdown-search-input'); 
    const chevron = dropdown.querySelector('.dropdown-chevron');
    const hiddenInput = dropdown.querySelector('input[name="region"]'); // if exists
    

    dropdown.addEventListener('mouseenter', function() {
      if (!dropdown.classList.contains('show')) {
        dropdown.classList.add('hover-show');
      }
    });

    if (searchInput) {
  const list = dropdown.querySelector('.dropdown-menu'); 
   
  // Fetch meters when input is focused
  searchInput.addEventListener('focus', function () {
    console.log(list.getAttribute("aria-labelledby")); 
    var path = '' ; 
    if(list.getAttribute("aria-labelledby") == "deviceDropdown"){
      path = '/get-installed-meters'; 
    }else if(list.getAttribute("aria-labelledby") == "zoneDropdown"){
      path = '/get-zone';  
    }else if(list.getAttribute("aria-labelledby") == "stationDropdown"){
      path = '/get-station';
    }else if(list.getAttribute("aria-labelledby") == "dcuDropdown"){
      path = '/get-installed-dcu';  
    }else if(list.getAttribute("aria-labelledby") == "archivedDropdown"){
      path = '/get-archived-meter'; 
    }else if(list.getAttribute("aria-labelledby") == "installedDropdown"){
      path = '/get-installed-meters';
    }
    fetch(path)
      .then(response => response.json())
      .then(data => {
        list.innerHTML = ''; // clear old items
        console.log(data); 
        data.forEach(element => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.className = 'dropdown-item hoverable-item';
          a.href = '#';
          a.textContent = element;
          a.setAttribute('data-value', element);  
          li.appendChild(a);
          list.appendChild(li);
        });

        dropdown.classList.add('show');
        dropdown.classList.remove('hover-show');
      });
  });

  // Real-time filtering — delegate to input
  searchInput.addEventListener('input', function () {
    const term = this.value.toLowerCase();
    const dropdownItems = list.querySelectorAll('.dropdown-item');
    dropdownItems.forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(term) ? 'block' : 'none'; 
    });
  });

  // Item selection — event delegation
  list.addEventListener('click', function (e) {
    if (e.target && e.target.matches('.dropdown-item')) {
      if (searchInput) searchInput.value = e.target.textContent;
      dropdown.classList.remove('show');
      if (hiddenInput) hiddenInput.value = e.target.getAttribute('data-value');
      e.preventDefault();
      
      if (list.getAttribute("aria-labelledby") === "archivedDropdown") {
        console.log("fillput")
      const selectedMeter = event.target.getAttribute('data-value');
      document.querySelector('#addMeterModal input[name="meter_number"]').value = selectedMeter;

      // Fetch full details for selected archived meter
      fetch(`/get-meter-details/${encodeURIComponent(selectedMeter)}`)
        .then(response => response.json())
        .then(data => {
          console.log(data) 
          if (data.error) {
            alert(data.error);
            return;
          }
          // Fill other fields inside the modal
          document.querySelector('#addMeterModal select[name="meter_type"]').value = data.device_type;
          document.querySelector('#addMeterModal input[name="comm_address"]').value = data.com_address;
          document.querySelector('#addMeterModal select[name="modem_type"]').value = data.type;
          document.querySelector('#addMeterModal input[name="remarks"]').value = data.remarks || '';
          document.querySelector('#addMeterModal input[name="password"]').value = data.password || '';
          console.log(document.querySelector('#addMeterModal input[name="password"]').value ) 
        })
        .catch(err => console.error("Error fetching meter details:", err));
    }
    
    }
  });
}

    // Chevron rotation
    if (chevron) {
      chevron.style.transition = 'transform 0.2s ease';
    }

    dropdown.addEventListener('show.bs.dropdown', () => {
      if (chevron) chevron.style.transform = 'translateY(-50%) rotate(180deg)';
    });
    dropdown.addEventListener('hide.bs.dropdown', () => {
      if (chevron) chevron.style.transform = 'translateY(-50%) rotate(0deg)';
    });

    // Close when clicking outside
    document.addEventListener('click', function(e) {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });
  });
});
$(document).ready(function () {
  // Add modal tree
  $('#parentNodeTree').jstree({
    core: {
      data: {
        url: '/line-tree-data',
        dataType: 'json'
      }
    }
  }).on("select_node.jstree", function (e, data) {
    $('#parent_node_input').val(data.node.text);
  });
  $('#editLineTree').jstree({
    core: {
      data: {
        url: '/line-tree-data',
        dataType: 'json'
      }
    }
  }).on("select_node.jstree", function (e, data) {
    $('#edit_line_input').val(data.node.text);
  }); 
  });



$('#parentNodeTree').on("changed.jstree", function (e, data) {
    if (data && data.selected && data.selected.length > 0) {
        // Get the selected node's text (name)
        let selectedNodeName = data.instance.get_node(data.selected[0]).text;
        
        // Set hidden input value
        document.getElementById('parent_node_input').value = selectedNodeName;
    } else {
        document.getElementById('parent_node_input').value = '';
    }
}); 
  </script>


{% endblock %}
