{% extends "base.html" %}
{% block content %}
{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %} 
<div class="p-4">
  <h2 class="mb-4">‚ö° Meter Management</h2>

  <form method = "GET" action = "/search-meter" class="row g-2 mb-3">
    <div class="col-md-2">
      <input type="text" class="form-control" placeholder="Meter No." name="meter_number" value="{{ meter_number | default('') }}">  
    </div>
    <div class="col-md-2">
      <div class="dropdown">
        <button class="btn btn-light border dropdown-toggle w-100 text-start position-relative dimmed-text"
                type="button"
                id="deviceDropdown"
                aria-expanded="false"
                style="height: 38px; text-align: left; border-radius: 2px !important;">
          –ë“Ø–ª—ç–≥
        </button>
        <ul class="dropdown-menu w-100"
            aria-labelledby="deviceDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px;">
          <!-- Search Box -->
          <div class="p-2 border-bottom">
            <input type="text" 
                   class="form-control form-control-sm search-input" 
                   placeholder="–•–∞–π—Ö..." 
                   style="border-radius: 2px;">
          </div>
          
          <!-- Options -->
          <div class="dropdown-options" style="max-height: 160px; overflow-y: auto;">
            <li><a class="dropdown-item" href="#" data-value="GPRS Meter" style="border-radius: 0 !important;">–î–∞–ª–∞–Ω–ó–∞–¥–≥–∞–¥</a></li>
            <li><a class="dropdown-item" href="#" data-value="PLC Meter" style="border-radius: 0 !important;">–¶–∞–≥–∞–∞–Ω —Ö–∞–¥</a></li>
          </div>
        </ul>
        <input type="hidden" name="device_type" required>
      </div>
    </div>
    <div class="col-md-2">
      <div class="dropdown">
        <button class="btn btn-light border dropdown-toggle w-100 text-start position-relative dimmed-text"
                type="button"
                id="deviceDropdown"
                aria-expanded="false"
                style="height: 38px; text-align: left;border-radius: 2px !important;">
          –¢–æ–æ–ª—É—É—Ä—ã–Ω —Ç”©—Ä”©–ª
        </button>
        <ul class="dropdown-menu w-100"
            aria-labelledby="deviceDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px;border-radius: 2px !important;">
          <li><a class="dropdown-item" href="#" data-value="GPRS Meter">GPRS Meter</a></li>
          <li><a class="dropdown-item" href="#" data-value="PLC Meter">PLC Meter</a></li>
        </ul>
        <input type="hidden" name="device_type" required>
      </div>
    </div>
    <div class="col-md-2">
      <div class="dropdown">
        <button class="btn btn-light border dropdown-toggle w-100 text-start position-relative dimmed-text"
                type="button"
                id="deviceDropdown"
                aria-expanded="false"
                style="height: 38px; text-align: left;border-radius: 2px !important;">
          –®—É–≥–∞–º
        </button>
        <ul class="dropdown-menu w-100"
            aria-labelledby="deviceDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px;border-radius: 2px !important;">
          <li><a class="dropdown-item" href="#" data-value="GPRS Meter">–¢–ü-78</a></li>
          <li><a class="dropdown-item" href="#" data-value="PLC Meter">–¢–ü-13</a></li>
        </ul>
        <input type="hidden" name="device_type" required>
      </div>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Search</button>
    </div>

    <div class="col-md-2">
        <button type="button" class="btn btn-dark w-100" data-bs-toggle="modal" data-bs-target="#addMeterModal">
            + Add
        </button>
    </div>
  </form>

  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Meter No.</th>
        <th>Comm Addr</th>
        <th>Meter Type</th>
        <th>Device Type</th>
        <th>remarks</th>
        <th>Create By</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for meter in installed_meters %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ meter['meter_number'] }}</td>
        <td>{{ meter['com_address'] }}</td>
        <td>{{ meter['type'] }}</td>
        <td>{{ meter['device_type'] }}</td>
        <td>{{ meter['remarks'] or '-' }}</td>
        <td>{{ meter['created_by'] }}</td>
        <td>
          {% if meter['status'] == 'Installed' %}
            <span class="badge bg-warning text-dark">Installed</span>
          {% elif meter['status'] == 'Archived' %}
            <span class="badge bg-secondary">Archived</span>
          {% else %}
            <span class="badge bg-light text-muted">Unknown</span>
          {% endif %}
        </td>
        <td>
          <button class="btn btn-sm btn-warning" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editMeterModal" 
                  data-original-meter-number="{{meter['meter_number']}}"  
                  data-meter-number="{{meter['meter_number']}}"
                  data-comm-address="{{ meter['com_address'] }}"
                  data-device-type="{{ meter['device_type'] }}"
                  data-type="{{ meter['type'] }}"
                  data-password="{{ meter['password'] }}"
                  data-remarks="{{ meter['remarks'] }}"
                  data-status="{{ meter['status'] }}"> 
            ‚úèÔ∏è Edit
          </button> 
          <!-- <button class="btn btn-sm btn-danger">üóëÔ∏è Delete</button> -->
          <form method="POST" action="/delete-meter" style="display:inline;" onsubmit="return confirmDelete();">  
            <input type="hidden" name="meter_number" value="{{ meter['meter_number'] }}"> 
            <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- add button form for meter adding  -->
 

<div class="modal fade" id="addMeterModal" tabindex="-1" aria-labelledby="addMeterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addMeterModalLabel">Add Meter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addMeterForm" method = "Post" action = "/add-meter">  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety-tab" data-bs-toggle="tab" data-bs-target="#safety" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail" role="tabpanel">
              
                
   
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select custom-select" name="device_type" required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>* Meter No.</label>
                    <input type="text" name="meter_number" class="form-control" required> 
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>* Type</label>
                    <select class="form-select" name="type" required> 
                      <option>DDSY283SR</option>
                      <option>DTSD545S</option> 
                      
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Status</label>
                    <input type="text" name="status" class="form-control"  value="Archived" readonly> 
                  </div>
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" class="form-control">
                  </div>
                </div>
  
  
              
            </div>
  
            <div class="tab-pane fade" id="safety" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" class="form-control" required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="addMeterForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

  

  <!-- edit meter form for meter edit --> 
  <div class="modal fade" id="editMeterModal" tabindex="-1" aria-labelledby="editMeterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addMeterModalLabel">Edit Meter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editMeterForm" method = "Post" action = "/edit-meter">   
            <input type="hidden" name="original_meter_number" id="OriginalMeterNumber">  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail1-tab" data-bs-toggle="tab" data-bs-target="#detail1" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety1-tab" data-bs-toggle="tab" data-bs-target="#safety1" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail1" role="tabpanel">
              
   
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select" name="device_type" id = "editDeviceType" required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>* Meter No.</label>
                    <input type="text" name="meter_number" id = "editMeterNumber" class="form-control" required> 
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" id = "editCommAddress" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>* Type</label>
                    <select class="form-select" name="type" id = "editType" required> 
                      <option>DDSY283SR</option>
                      <option>DTSD545S</option> 
                      
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Status</label>
                    <input type="text" name="status" class="form-control"  value="Archived" readonly> 
                  </div>
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" id = "editRemarks" class="form-control">
                  </div>
                </div>
  
  
              
            </div>
  
            <div class="tab-pane fade" id="safety1" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" id = "editPassword" class="form-control" required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="editMeterForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>
 
  <script>

    const editModal = document.getElementById('editMeterModal');
    editModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;

      document.getElementById('OriginalMeterNumber').value = button.getAttribute('data-meter-number'); 
      document.getElementById('editMeterNumber').value = button.getAttribute('data-meter-number');
      document.getElementById('editCommAddress').value = button.getAttribute('data-comm-address');
      document.getElementById('editDeviceType').value = button.getAttribute('data-device-type');
      document.getElementById('editType').value = button.getAttribute('data-type');
      document.getElementById('editPassword').value = button.getAttribute('data-password');
      document.getElementById('editRemarks').value = button.getAttribute('data-remarks');
    });
    function confirmDelete(){
      return confirm("‚ö†Ô∏è Are you sure you want to delete this meter?");
    }
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      const dropdown = this.closest('.dropdown');
      
      // Close other open dropdowns
      document.querySelectorAll('.dropdown.show').forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
      });
      
      // Toggle current dropdown
      dropdown.classList.toggle('show');
    });
  });

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown.show').forEach(dropdown => {
        dropdown.classList.remove('show');
      });
    }
  });

  // Handle dropdown item selection
  document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const dropdown = this.closest('.dropdown');
      const value = this.getAttribute('data-value');
      const text = this.textContent;
      
      // Update the toggle button text
      dropdown.querySelector('.dropdown-toggle').textContent = text;
      
      // Update the hidden input value if exists
      const hiddenInput = dropdown.querySelector('input[type="hidden"]');
      if (hiddenInput) hiddenInput.value = value;
      
      dropdown.classList.remove('show');
    });
  });

  document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.querySelector('.search-input');
  const dropdownItems = document.querySelectorAll('.dropdown-item');
  
  // Search functionality
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    dropdownItems.forEach(item => {
      const text = item.textContent.toLowerCase();
      if (text.includes(searchTerm)) {
        item.style.display = "block";
      } else {
        item.style.display = "none";
      }
    });
  });
  
  // Preserve your existing animations
  const dropdownToggle = document.querySelector('.dropdown-toggle');
  dropdownToggle.addEventListener('click', function() {
    const dropdown = this.closest('.dropdown');
    dropdown.classList.toggle('show');
    
    // Reset search on open
    if (dropdown.classList.contains('show')) {
      searchInput.value = '';
      dropdownItems.forEach(item => {
        item.style.display = "block";
      });
    }
  });
});
  </script>


{% endblock %}
