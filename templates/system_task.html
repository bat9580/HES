{% extends "base.html" %}

{% block content %}
{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %} 
<h2 class="mb-4">🔌 Task config</h2> 
<form method="GET" action="/search-task" class="d-flex flex-wrap align-items-center mb-3 gap-2"> 
    <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 name="task_name"
                 placeholder="таск хайх"
                 value="{{ task_name | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
    </div>
    <!-- <input type="text" class="form-control" style="max-width: 200px;" placeholder="Device Addr" name="dcu_number" value="{{ dcu_number | default('') }}"> -->
    
    <div class="col-md-auto" style="width: 4.166666%;">
      <button type="submit" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" > 
        <i class="bi bi-search"></i> 
      </button>
    </div>
    <div class="col-md-auto">
      <button type="button" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" data-bs-toggle="modal" data-bs-target="#addTaskModal">
          <i class="bi bi-plus-lg"></i>
      </button>
    </div>
    <div class="col-md-auto" >
      <button type="submit" class="btn btn-light w-100 border dimmed-text" id="clear-selected-button" style="height: 33px; border-radius: 2px" > 
        <i class="bi bi-trash3"> Clear selected</i> 
      </button>
    </div>
    
        

</form> 

<table class="table table-bordered table-hover table-striped align-middle text-center">
  <thead class="table-light">
    <tr>
      <th><input type="checkbox" id="select-all"></th>
      <th>#</th>
      <th>Task Name</th>
      <th>Invoke Target</th>
      <th>Cron Expression</th>
      <th>Remarks</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="device-table-body">
    {% for task in tasks %} 
    <tr>
      <td><input type="checkbox" class="device-checkbox" value="{{ task['task_name']}}"></td>  
      <td>{{ loop.index }}</td>
      <td>{{ task['task_name'] }}</td> 
      <td>{{ task['invoke_target'] }}</td>
      <td>{{ task['cron_expression'] }}</td>
      <td>{{ task['remark'] }}</td>
      <td>
        <button class="btn btn-secondary btn-sm" 
                data-bs-toggle="modal" 
                data-bs-target="#editTaskModal"    
                data-task-name="{{task['task_name']}}"  
                data-invoke-target="{{task['invoke_target']}}"
                data-cron-expression="{{ task['cron_expression'] }}"
                data-remarks="{{ task['remark'] }}" >
              Edit
        </button> 
      </td> 
    </tr>
    {% endfor %}
    <!-- dynamic rows here -->
  </tbody>
</table>
<!-- Add button form for adding task  -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog custom-modal modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTaskModalLabel">Add task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addTaskForm" method = "Post" action = "/add-task">     
        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
          <li class="nav-item">
            <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">Detail</button>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div class="tab-pane fade show active" id="detail" role="tabpanel">
                
                <div class="col-md-auto">
                  <label>Task Name</label>
                  <input type="text" name="task_name" class="form-control" required> 
                </div>

                <div class="col-md-auto">
                  <label>Invoke_target</label>
                  <select class="form-select" name="invoke_target"  required> 
                    <option>Energy load profile</option>
                    <option>Instantanious load profile</option>
                    <option>Voltage read</option> 
                  </select>
                </div>

                <!-- <div class="col-md-auto">
                  <label>Cron Expression</label>
                  <input type="text" name="cron_expression" id="cron_expression_input"  class="form-control" required>
                </div> -->
                <div class="col-md-auto">
                  <label>Cron Expression</label>
                  <input type="text" name="cron_expression" id="cron_expression_input" class="form-control" required>
                  <div id="error-message" style="color: red; display: none;">
                    Invalid cron expression. Please enter a valid one.
                  </div>
                </div>
                <div class="col-md-auto">
                  <label>Remarks</label>
                  <input type="text" name = "remarks" class="form-control">
                </div>
          </div>
        </div>
      </form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="addTaskForm" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit button form for editing task  -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog custom-modal modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTaskModalLabel">Edit task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editTaskForm" method = "Post" action = "/edit-task">  
            <input type="hidden" name="original_task_name" id="OriginalTaskName">   
        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
          <li class="nav-item">
            <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">Detail</button>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div class="tab-pane fade show active" id="detail" role="tabpanel">
                
                <div class="col-md-auto">
                  <label>Task Name</label>
                  <input type="text" name="task_name" id="editTaskName" class="form-control" required> 
                </div>

                <div class="col-md-auto">
                  <label>Invoke_target</label>
                  <select class="form-select" name="invoke_target" id="editInvokeTarget" required> 
                    <option>Energy load profile</option>
                    <option>Instantanious load profile</option>
                    <option>Voltage read</option> 
                  </select>
                </div>

                <!-- <div class="col-md-auto">
                  <label>Cron Expression</label>
                  <input type="text" name="cron_expression" id="editCronExpression"  class="form-control" required>
                </div> -->
                <div class="col-md-auto">
                  <label>Cron Expression</label>
                  <input type="text" name="cron_expression" id="edit_cron_expression_input" class="form-control" required>
                  <div id="error-message-edit" style="color: red; display: none;">
                    Invalid cron expression. Please enter a valid one. 
                  </div>
                </div>
              
                <div class="col-md-auto">
                  <label>Remarks</label>
                  <input type="text" name = "remarks" id="editRemarks" class="form-control">
                </div>
          </div>
        </div>
      </form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="editTaskForm" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>









<style>
  th, td { text-align: center; vertical-align: middle; }
  .btn-sm { padding: 4px 10px; font-size: 13px; }
  .form-control, .form-select { height: 32px; font-size: 14px; }
</style>

<script>
document.getElementById("addTaskForm").addEventListener("submit", function (event) {
    const input = document.getElementById("cron_expression_input").value;
    const errorMessage = document.getElementById("error-message");

    try {
      const desc = cronstrue.toString(input);  // ✅ Tries to parse it
      console.log("Valid cron:", desc);
      errorMessage.style.display = "none";
    } catch (e) {
      console.error("Invalid cron:", e.message);
      errorMessage.style.display = "block";
      event.preventDefault(); // ⛔ Prevent submission
    }
  });
document.getElementById("editTaskForm").addEventListener("submit", function (event) {
    const input = document.getElementById("edit_cron_expression_input").value;
    const errorMessage = document.getElementById("error-message-edit");

    try {
      const desc = cronstrue.toString(input);  // ✅ Tries to parse it
      console.log("Valid cron:", desc);
      errorMessage.style.display = "none";
    } catch (e) {
      console.error("Invalid cron:", e.message);
      errorMessage.style.display = "block";
      event.preventDefault(); // ⛔ Prevent submission
    }
  });

document.getElementById('clear-selected-button').addEventListener('click', function () {
  const selectedTasks = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);

  if (selectedTasks.length === 0) {
    alert("Please select at least one Task.");
    return;
  }

  fetch('/clear-task', { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      selected_tasks: selectedTasks 
    })
  }); 

});
  // Select All checkbox
  document.getElementById("select-all").addEventListener("click", function() {
    const checkboxes = document.querySelectorAll(".device-checkbox");
    checkboxes.forEach(cb => cb.checked = this.checked);
  });

  const editTaskModal = document.getElementById('editTaskModal');
    editTaskModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;

      document.getElementById('OriginalTaskName').value = button.getAttribute('data-task-name'); 
      document.getElementById('editTaskName').value = button.getAttribute('data-task-name');
      document.getElementById('editInvokeTarget').value = button.getAttribute('data-invoke-target');
      document.getElementById('edit_cron_expression_input').value = button.getAttribute('data-cron-expression');
      document.getElementById('editRemarks').value = button.getAttribute('data-remarks');
    });

</script>

{% endblock %} 