{% extends "base.html" %}
{% block content %}

{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %} 
<div class="p-4">
  <h2 class="mb-4">Шугамууд</h2> 

  <form method = "GET" action = "/search-line" class="row g-2 mb-3">
    <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 name="line_name"
                 placeholder="Шугам хайх"
                 value="{{ line_name | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
        </div>
      </div>
    </div>

        
    <div class="col-md-auto" style="width: 4.166666%;">
      <button type="submit" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" > 
        <i class="bi bi-search"></i> 
      </button>
    </div>
    

    <div class="col-md-auto" style="width: 4.166666%;"> 
        <button type="button" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" data-bs-toggle="modal" data-bs-target="#addLineModal">
          <i class="bi bi-plus-lg"></i>
        </button>
    </div>
  </form>

  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Нэр</th>
        <th>Шугамын түвшин</th>
        <th>Харьяа шугам</th>
        <th>Үйлдэл</th> 
      </tr>
    </thead>
    <tbody>
      {% for line in lines %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ line['line_name'] }}</td> 
        <td>{{ line['line_level'] }}</td>
        <td>{{ line['parent_node'] or '' }}</td>
        
        <td>
          <button class="btn btn-sm btn-secondary" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editLineModal" 
                  data-original-line-name="{{line['line_name']}}"  
                  data-line-name="{{line['line_name']}}"
                  data-line-level="{{ line['line_level'] }}"
                  data-parent-node="{{ line['parent_node'] }}">  
            <i class="bi bi-pencil-square"> Edit</i>
          </button> 
          <form method="POST" action="/delete-line" style="display:inline;" onsubmit="return confirmDelete();">   
            <input type="hidden" name="line_name" value="{{ line['line_name'] }}">   
            <button type="submit" class="btn btn-sm btn-danger">
              <i class="bi bi-trash"> Delete</i>
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- add button form for meter adding  -->
 

<div class="modal fade" id="addLineModal" tabindex="-1" aria-labelledby="addLineModalLabel" aria-hidden="true">
  <div class="modal-dialog custom-modal modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addLineModalLabel">Шугам үүсгэх</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addLineForm" method = "Post" action = "/add-line">     
        <div class="tab-content">
          <div class="tab-pane fade show active"  role="tabpanel">
                
                <div class="col-md-auto">
                  <label>Шугамын нэр</label> 
                  <input type="text" name="line_name" class="form-control" required> 
                </div>

                <div class="col-md-auto">
                  <label>Шугамын түвшин</label>
                  <select class="form-select" name="line_level"  required> 
                    <option>Цахилгаан станц</option>
                    <option>Дэд станц</option>
                    <option>Фидер</option> 
                    <option>Трансформер</option> 
                  </select>
                </div>
                <div class="col-md-auto mb-3">
                <label class="form-label d-block">Үечлэл</label> 
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="lineType" id="newLine" value="new" checked>
                            <label class="form-check-label" for="newLine">Шинэ</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="lineType" id="existingLine" value="existing">
                            <label class="form-check-label" for="existingLine">Харьяа</label>
                        </div>
                </div>
                <div class="col-md-auto" id="parentNodeWrapper" style="display:none;">
                        <label>Харьяа шугам</label>
                        <div id="parentNodeTree"></div>
                        <input type="hidden" name="parent_node" id="parent_node_input">
                </div>
          </div>
        </div>
      </form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="addLineForm" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>
  

  <!-- edit meter form for meter edit --> 
  <div class="modal fade" id="editLineModal" tabindex="-1" aria-labelledby="editLineModalLabel" aria-hidden="true">
  <div class="modal-dialog custom-modal modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editLineModalLabel">Шугам засах</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editLineForm" method="POST" action="/edit-line">
          <div class="tab-content">
            <div class="tab-pane fade show active" role="tabpanel">

              <div class="col-md-auto">
                <label>Шугамын нэр</label>
                <!-- Hidden input to hold original line name for identifying the record -->
                <input type="hidden" name="original_line_name" id="original_line_name">
                <input type="text" name="line_name" id="edit_line_name" class="form-control" required>
              </div>

              <div class="col-md-auto">
                <label>Шугамын түвшин</label>
                <select class="form-select" name="line_level" id="edit_line_level" required>
                  <option>Цахилгаан станц</option>
                  <option>Дэд станц</option>
                  <option>Фидер</option>
                  <option>Трансформер</option>
                </select>
              </div>

              <div class="col-md-auto mb-3">
                <label class="form-label d-block">Үечлэл</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="lineTypeEdit" id="editNewLine" value="new" checked>
                  <label class="form-check-label" for="editNewLine">Шинэ</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="lineTypeEdit" id="editExistingLine" value="existing">
                  <label class="form-check-label" for="editExistingLine">Харьяа</label>
                </div>
              </div>

              <div class="col-md-auto" id="editParentNodeWrapper" style="display:none;">
                <label>Харьяа шугам</label>
                <div id="editParentNodeTree"></div>
                <input type="hidden" name="parent_node" id="edit_parent_node_input">
              </div>

            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="editLineForm" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>

 
  <script>
    const editModal = document.getElementById('editLineModal');
    editModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;

      document.getElementById('original_line_name').value = button.getAttribute('data-original-line-name'); 
      document.getElementById('edit_line_name').value = button.getAttribute('data-line-name');
      document.getElementById('edit_line_level').value = button.getAttribute('data-line-level');
      const parentNode = button.getAttribute('data-parent-node');
      console.log(parentNode) 
     const wrapper = document.getElementById('editParentNodeWrapper');

        if (parentNode && parentNode.trim() !== '') {
            wrapper.style.display = 'block';
            document.getElementById('edit_parent_node_input').value = parentNode;
            document.getElementById('editExistingLine').checked = true;  // select "existing" radio
        } else {
            wrapper.style.display = 'none';
            document.getElementById('edit_parent_node_input').value = '';
            document.getElementById('editNewLine').checked = true;  // select "new" radio
        }
    });
    document.querySelectorAll('input[name="lineTypeEdit"]').forEach(radio => {
  radio.addEventListener('change', function() {
    const wrapper = document.getElementById('editParentNodeWrapper');
    if (this.value === 'existing') {
      wrapper.style.display = 'block';
      document.getElementById('edit_parent_node_input').setAttribute('required', 'required');
    } else {
      wrapper.style.display = 'none';
      document.getElementById('edit_parent_node_input').removeAttribute('required');
      document.getElementById('edit_parent_node_input').value = '';
    }
  });
});
    function confirmDelete(){
      return confirm("⚠️ Are you sure you want to delete this Line?"); 
    }



    // for modal 
    document.querySelectorAll('input[name="lineType"]').forEach(radio => {
    radio.addEventListener('change', function () {
    const cronWrapper = document.getElementById('parentNodeWrapper'); 
    if (this.value === 'existing') {
      cronWrapper.style.display = 'block';
      document.getElementById('parent_node_input').setAttribute('required', 'required');
    } else {
      cronWrapper.style.display = 'none';
      document.getElementById('parent_node_input').removeAttribute('required');
      document.getElementById('parent_node_input').value = ''; 
    }
  });
}); 


$(document).ready(function () {
  // Add modal tree
  $('#parentNodeTree').jstree({
    core: {
      data: {
        url: '/line-tree-data',
        dataType: 'json'
      }
    }
  }).on("select_node.jstree", function (e, data) {
    $('#parent_node_input').val(data.node.text);
  });

  // Edit modal tree
  $('#editParentNodeTree').jstree({
    core: {
      data: {
        url: '/line-tree-data',
        dataType: 'json'
      }
    }
  }).on("select_node.jstree", function (e, data) {
    $('#edit_parent_node_input').val(data.node.text);
  });
});
  </script>


{% endblock %}
