{% extends "base.html" %}

{% block content %}

<h2 class="mb-4">Энергийн Профайл унших</h2>
<form method="GET" action="/search-energy-profile" class="d-flex flex-wrap align-items-center mb-3 gap-2"> 
    <div class="col-md-auto" style="width: 15%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 name="meter_number"
                 placeholder="Тоолуур хайх"
                 value="{{ meter_number | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
          <span class="dropdown-chevron position-absolute end-0 top-50 translate-middle-y me-2">
            <svg width="25" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </div>
        
        <ul id="installed-meter-list" 
            class="dropdown-menu w-100"
            aria-labelledby="deviceDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
        </ul>
        <input type="hidden" name="device_type" required>
      </div>
    </div>

    
    <div class="col-md-auto  position-relative " style="width: 15%; min-height: 35px; height: auto;"> 
          <select 
              class="form-select dropdown-search-input dimmed-text hoverable-input"
              style="height: 33px; border-radius: 2px !important; padding-right: 30px;"> 
            <option>Энергийн Профайл</option> 
          </select>
    </div>
    <div class="col-md-auto position-relative d-flex align-items-center" style="width: 30%; min-height: 35px; height: auto;">
        <input type="text" id="daterange" class="form-control" 
              style="max-width: 400px; height: 33px; border-radius: 2px !important; padding-right: 10px;">
        <!-- Hidden inputs to submit the dates -->
        <input type="hidden" id="start_date" name="start_date" value="{{ start_date | default('') }}">
        <input type="hidden" id="end_date" name="end_date" value="{{ end_date | default('') }}">
    </div>
    <div class="col-md-auto  position-relative " style="width: 15%; min-height: 35px; height: auto;"> 
          <select 
              name = "type" 
              class="form-select dropdown-search-input dimmed-text hoverable-input"
              style="height: 33px; border-radius: 2px !important; padding-right: 30px;"> 
             <option value="Original" {% if selected_type == "Original" %}selected{% endif %}>Original</option>  
            <option value="Calculated" {% if selected_type == "Calculated" %}selected{% endif %}>Calculated</option> 
          </select>
    </div> 

    
    <div class="col-md-auto" style="width: 4.166666%;">
      <button type="submit" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" > 
        <i class="bi bi-search"></i> 
      </button>
    </div>
    <div class="col-md-auto">
      <button type="button" onclick="exportTableToExcel('my-table')" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px">
        <i class="bi bi-upload"></i>
      </button>
    </div>
</form> 
<table id="my-table" class="table table-bordered table-hover table-striped align-middle text-center">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Meter No.</th> 
        <th>Time</th> 
        <th>Total Import Active Energy (1.8.0)</th> 
        <th>Import Active Energy T1 (1.8.1)</th> 
        <th>Import Active Energy T2 (1.8.2)</th> 
        <th>Import Active Energy T2 (1.8.3)</th> 
        <th>Total Export Active Energy (2.8.0)</th> 
        <th>Export Active Energy T1 (2.8.1)</th> 
        <th>Export Active Energy T2 (2.8.2)</th> 
        <th>Export Active Energy T3 (2.8.3)</th> 
        <th>Total Import Reactive Energy (3.8.0)</th> 
        <th>Import Reactive Energy T1 (3.8.1)</th> 
        <th>Import Reactive Energy T2 (3.8.2)</th> 
        <th>Import Reactive Energy T3 (3.8.3)</th> 
        <th>Total Export Reactive Energy (4.8.0)</th> 
        <th>Export Reactive Energy T1 (4.8.1)</th> 
        <th>Export Reactive Energy T2 (4.8.2)</th>
        <th>Export Reactive Energy T3 (4.8.3)</th>
      </tr>
    </thead>
    <tbody id="device-table-body">
      {% for reading in readings %}  
      <tr>
        <td>{{ loop.index }}</td> 
        <td>{{ reading['meter_number'] }}</td> 
        <td>{{ reading['timestamp'] }}</td> 
        <td>{{ reading['import_total_active_energy'] }}</td>  
        <td>{{ reading['import_active_energy_T1'] }}</td> 
        <td>{{ reading['import_active_energy_T2'] }}</td>
        <td>{{ reading['import_active_energy_T3'] }}</td>
        <td>{{ reading['export_total_active_energy'] }}</td>  
        <td>{{ reading['export_active_energy_T1'] }}</td> 
        <td>{{ reading['export_active_energy_T2'] }}</td>
        <td>{{ reading['export_active_energy_T3'] }}</td>
        <td>{{ reading['import_total_reactive_energy'] }}</td>  
        <td>{{ reading['import_reactive_energy_T1'] }}</td> 
        <td>{{ reading['import_reactive_energy_T2'] }}</td>
        <td>{{ reading['import_reactive_energy_T3'] }}</td>
        <td>{{ reading['export_total_reactive_energy'] }}</td>  
        <td>{{ reading['export_reactive_energy_T1'] }}</td> 
        <td>{{ reading['export_reactive_energy_T2'] }}</td>
        <td>{{ reading['export_reactive_energy_T3'] }}</td>
      </tr> 
      {% endfor %}
    </tbody>
  </table>

<style>
  th, td { text-align: center; vertical-align: middle; }
  .btn-sm { padding: 4px 10px; font-size: 13px; }
  .form-control, .form-select { height: 32px; font-size: 14px; }
</style>

<script>

$(function() {
  // Parse dates from server or fallback to current hour
  const startDateStr = "{{ start_date | default('') }}";
  const endDateStr = "{{ end_date | default('') }}";

  const startDate = startDateStr ? moment(startDateStr, 'YYYY-MM-DD[T]HH:mm:ss') : moment().startOf('hour');
  const endDate = endDateStr ? moment(endDateStr, 'YYYY-MM-DD[T]HH:mm:ss') : moment().endOf('hour');

  $('#daterange').daterangepicker({
    timePicker: true,
    timePicker24Hour: true,
    timePickerSeconds: true,
    locale: {
      format: 'YYYY-MM-DD[T]HH:mm:ss',
      separator: 'T'
    },
    startDate: startDate,
    endDate: endDate
  }, function(start, end) {
    // Update hidden inputs on user change
    $('#start_date').val(start.format('YYYY-MM-DD[T]HH:mm:ss'));
    $('#end_date').val(end.format('YYYY-MM-DD[T]HH:mm:ss'));
  });

  // Also set the initial value in the visible input so the user sees it
  $('#daterange').val(startDate.format('YYYY-MM-DD[T]HH:mm:ss') + 'T' + endDate.format('YYYY-MM-DD[T]HH:mm:ss'));
});

function exportTableToExcel(tableId) {
  const table = document.getElementById(tableId);
  const workbook = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
  XLSX.writeFile(workbook, "Meter_Readings.xlsx");
}


document.addEventListener('DOMContentLoaded', function() {
  const dropdowns = document.querySelectorAll('.dropdown');  
  dropdowns.forEach(function(dropdown) {
    const searchInput = dropdown.querySelector('.dropdown-search-input'); 
    const chevron = dropdown.querySelector('.dropdown-chevron');
    const hiddenInput = dropdown.querySelector('input[name="region"]'); // if exists
    

    dropdown.addEventListener('mouseenter', function() {
      if (!dropdown.classList.contains('show')) {
        dropdown.classList.add('hover-show');
      }
    });

    if (searchInput) {
  const list = dropdown.querySelector('.dropdown-menu'); 
   
  // Fetch meters when input is focused
  searchInput.addEventListener('focus', function () {
    console.log(list.getAttribute("aria-labelledby")); 
    var path = '' ; 
    if(list.getAttribute("aria-labelledby") == "deviceDropdown"){
      path = '/get-installed-meters'; 
    }else if(list.getAttribute("aria-labelledby") == "zoneDropdown"){
      path = '/get-zone';  
    }else if(list.getAttribute("aria-labelledby") == "stationDropdown"){
      path = '/get-station';
    }else if(list.getAttribute("aria-labelledby") == "dcuDropdown"){
      path = '/get-installed-dcu';  
    }else if(list.getAttribute("aria-labelledby") == "archivedDropdown"){
      path = '/get-archived-meter'; 
    }else if(list.getAttribute("aria-labelledby") == "installedDropdown"){
      path = '/get-installed-meters';
    }
    fetch(path)
      .then(response => response.json())
      .then(data => {
        list.innerHTML = ''; // clear old items
        console.log(data); 
        data.forEach(element => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.className = 'dropdown-item hoverable-item';
          a.href = '#';
          a.textContent = element;
          a.setAttribute('data-value', element);  
          li.appendChild(a);
          list.appendChild(li);
        });

        dropdown.classList.add('show');
        dropdown.classList.remove('hover-show');
      });
  });

  // Real-time filtering — delegate to input
  searchInput.addEventListener('input', function () {
    const term = this.value.toLowerCase();
    const dropdownItems = list.querySelectorAll('.dropdown-item');
    dropdownItems.forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(term) ? 'block' : 'none'; 
    });
  });

  // Item selection — event delegation
  list.addEventListener('click', function (e) {
    if (e.target && e.target.matches('.dropdown-item')) {
      if (searchInput) searchInput.value = e.target.textContent;
      dropdown.classList.remove('show');
      if (hiddenInput) hiddenInput.value = e.target.getAttribute('data-value');
      e.preventDefault();
    }
  });
}

    // Chevron rotation
    if (chevron) {
      chevron.style.transition = 'transform 0.2s ease';
    }

    dropdown.addEventListener('show.bs.dropdown', () => {
      if (chevron) chevron.style.transform = 'translateY(-50%) rotate(180deg)';
    });
    dropdown.addEventListener('hide.bs.dropdown', () => {
      if (chevron) chevron.style.transform = 'translateY(-50%) rotate(0deg)';
    });

    // Close when clicking outside
    document.addEventListener('click', function(e) {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('show'); 
      }
    });
  });
});

</script>

{% endblock %} 