{% extends "base.html" %}

{% block content %}

<h2 class="mb-4">Татсан өгөгдөл унших</h2>
<form method="GET" action="/search-one-reading" class="d-flex flex-wrap align-items-center mb-3 gap-2"> 
    <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 name="meter_number"
                 placeholder="Тоолуур хайх"
                 value="{{ meter_number | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
          <span class="dropdown-chevron position-absolute end-0 top-50 translate-middle-y me-2">
            <svg width="25" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </div>
        
        <ul id="installed-meter-list" 
            class="dropdown-menu w-100"
            aria-labelledby="deviceDropdown"
            style="max-height: 200px; overflow-y: auto; top: 100%; left: 0; margin-top: 5px; border-radius: 2px !important;">
        </ul>
        <input type="hidden" name="device_type" required>
      </div>
    </div>
    <div class="col-md-auto position-relative" style="width: 20%; min-height: 35px; height: auto;"> 
  <select
      name="obis_code" 
      class="form-select dropdown-search-input dimmed-text hoverable-input"
      style="height: 33px; border-radius: 2px !important; padding-right: 30px;"> 

    <option value="1.8.0" {% if selected_obis_code == "1.8.0" %}selected{% endif %}>Total Import Active Energy (1.8.0)</option>  
    <option value="1.8.1" {% if selected_obis_code == "1.8.1" %}selected{% endif %}>Import Active Energy T1 (1.8.1)</option>
    <option value="1.8.2" {% if selected_obis_code == "1.8.2" %}selected{% endif %}>Import Active Energy T2 (1.8.2)</option>
    <option value="1.8.3" {% if selected_obis_code == "1.8.3" %}selected{% endif %}>Import Active Energy T2 (1.8.3)</option>
    
    <option value="2.8.0" {% if selected_obis_code == "2.8.0" %}selected{% endif %}>Total Export Active Energy (2.8.0)</option>
    <option value="2.8.1" {% if selected_obis_code == "2.8.1" %}selected{% endif %}>Export Active Energy T1 (2.8.1)</option>
    <option value="2.8.2" {% if selected_obis_code == "2.8.2" %}selected{% endif %}>Export Active Energy T2 (2.8.2)</option>
    <option value="2.8.3" {% if selected_obis_code == "2.8.3" %}selected{% endif %}>Export Active Energy T3 (2.8.3)</option>

    <option value="3.8.0" {% if selected_obis_code == "3.8.0" %}selected{% endif %}>Total Import Reactive Energy (3.8.0)</option>
    <option value="3.8.1" {% if selected_obis_code == "3.8.1" %}selected{% endif %}>Import Reactive Energy T1 (3.8.1)</option>
    <option value="3.8.2" {% if selected_obis_code == "3.8.2" %}selected{% endif %}>Import Reactive Energy T2 (3.8.2)</option>
    <option value="3.8.3" {% if selected_obis_code == "3.8.3" %}selected{% endif %}>Import Reactive Energy T3 (3.8.3)</option>

    <option value="4.8.0" {% if selected_obis_code == "4.8.0" %}selected{% endif %}>Total Export Reactive Energy (4.8.0)</option>
    <option value="4.8.1" {% if selected_obis_code == "4.8.1" %}selected{% endif %}>Export Reactive Energy T1 (4.8.1)</option>
    <option value="4.8.2" {% if selected_obis_code == "4.8.2" %}selected{% endif %}>Export Reactive Energy T2 (4.8.2)</option>
    <option value="4.8.3" {% if selected_obis_code == "4.8.3" %}selected{% endif %}>Export Reactive Energy T3 (4.8.3)</option> 

    <option value="32.7.0" {% if selected_obis_code == "32.7.0" %}selected{% endif %}>A фазын хүчдэл (32.7.0)</option>
    <option value="52.7.0" {% if selected_obis_code == "52.7.0" %}selected{% endif %}>Б фазын хүчдэл (52.7.0)</option>
    <option value="72.7.0" {% if selected_obis_code == "72.7.0" %}selected{% endif %}>С фазын хүчдэл (72.7.0)</option>

    <option value="31.7.0" {% if selected_obis_code == "31.7.0" %}selected{% endif %}>A фазын гүйдэл (31.7.0)</option>
    <option value="51.7.0" {% if selected_obis_code == "51.7.0" %}selected{% endif %}>Б фазын гүйдэл (51.7.0)</option>
    <option value="71.7.0" {% if selected_obis_code == "71.7.0" %}selected{% endif %}>С фазын гүйдэл (71.7.0)</option>

    <option value="15.7.0" {% if selected_obis_code == "15.7.0" %}selected{% endif %}>Нийт актив чадал (15.7.0)</option>
    <option value="21.7.0" {% if selected_obis_code == "21.7.0" %}selected{% endif %}>A фазын актив чадал (21.7.0)</option>
    <option value="41.7.0" {% if selected_obis_code == "41.7.0" %}selected{% endif %}>Б фазын актив чадал (41.7.0)</option>
    <option value="61.7.0" {% if selected_obis_code == "61.7.0" %}selected{% endif %}>С фазын актив чадал (61.7.0)</option>

    <option value="3.7.0" {% if selected_obis_code == "3.7.0" %}selected{% endif %}>Нийт реактив чадал (3.7.0)</option>
    <option value="23.7.0" {% if selected_obis_code == "23.7.0" %}selected{% endif %}>A фазын реактив чадал (23.7.0)</option>
    <option value="43.7.0" {% if selected_obis_code == "43.7.0" %}selected{% endif %}>Б фазын реактив чадал (43.7.0)</option>
    <option value="63.7.0" {% if selected_obis_code == "63.7.0" %}selected{% endif %}>С фазын реактив чадал (63.7.0)</option>

    <option value="14.7.0" {% if selected_obis_code == "14.7.0" %}selected{% endif %}>Давтамж (14.7.0)</option>
  </select>
</div>
    <!-- <input type="text" class="form-control" style="max-width: 200px;" placeholder="Device Addr" name="dcu_number" value="{{ dcu_number | default('') }}"> -->
    <div class="col-md-auto position-relative d-flex align-items-center" style="width: 35%; min-height: 35px; height: auto;">
  <input 
    type="text" 
    id="daterange" 
    class="form-control" 
    style="max-width: 300px; height: 33px; border-radius: 2px !important; padding-right: 10px;"
    readonly
  >
</div>

<!-- Hidden inputs to submit dates -->
<input type="hidden" id="start_date" name="start_date" value="{{ start_date | default('') }}">
<input type="hidden" id="end_date" name="end_date" value="{{ end_date | default('') }}">
    <div class="col-md-auto  position-relative " style="width: 15%; min-height: 35px; height: auto;"> 
          <select 
              name = "type" 
              class="form-select dropdown-search-input dimmed-text hoverable-input"
              style="height: 33px; border-radius: 2px !important; padding-right: 30px;"> 
             <option value="Original" {% if selected_type == "Original" %}selected{% endif %}>Original</option>  
            <option value="Calculated" {% if selected_type == "Calculated" %}selected{% endif %}>Calculated</option> 
          </select>
    </div>
    
    <div class="col-md-auto" style="width: 4.166666%;">
      <button type="submit" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" > 
        <i class="bi bi-search"></i> 
      </button>
    </div>
  
</form> 

<table class="table table-bordered table-hover table-striped align-middle text-center">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Meter No.</th>
      <th>Time</th> 
      <th>value</th>  
    </tr>
  </thead>
  <tbody id="device-table-body">
    {% for reading in readings %}  
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ reading['meter_number'] }}</td> 
      <td>{{ reading['timestamp'] }}</td>  
      <td>{{ reading[column]}}</td>
      <td>    
      </td> 
    </tr>
    {% endfor %}
    <!-- dynamic rows here -->
  </tbody>
</table>



<style>
  th, td { text-align: center; vertical-align: middle; }
  .btn-sm { padding: 4px 10px; font-size: 13px; }
  .form-control, .form-select { height: 32px; font-size: 14px; }
</style>

<script>



$(function() {
  // Get the dates passed from backend, or empty strings if none
  const startDateStr = "{{ start_date | default('') }}";
  const endDateStr = "{{ end_date | default('') }}";

  // Parse dates or fallback to current hour start/end
  const startDate = startDateStr ? moment(startDateStr, 'YYYY-MM-DD[T]HH:mm:ss') : moment().startOf('hour');
  const endDate = endDateStr ? moment(endDateStr, 'YYYY-MM-DD[T]HH:mm:ss') : moment().endOf('hour');

  $('#daterange').daterangepicker({
    timePicker: true,
    timePicker24Hour: true,
    timePickerSeconds: true,
    locale: {
      format: 'YYYY-MM-DD[T]HH:mm:ss',
      separator: 'T'
    },
    startDate: startDate,
    endDate: endDate
  }, function(start, end) {
    // Update hidden inputs on user change
    $('#start_date').val(start.format('YYYY-MM-DD[T]HH:mm:ss'));
    $('#end_date').val(end.format('YYYY-MM-DD[T]HH:mm:ss'));
  });

  // Also set the input's visible value so user sees the current range
  $('#daterange').val(startDate.format('YYYY-MM-DD[T]HH:mm:ss') + 'T' + endDate.format('YYYY-MM-DD[T]HH:mm:ss'));
});

  document.addEventListener('DOMContentLoaded', function() {
  const dropdowns = document.querySelectorAll('.dropdown');  
  dropdowns.forEach(function(dropdown) {
    const searchInput = dropdown.querySelector('.dropdown-search-input'); 
    const chevron = dropdown.querySelector('.dropdown-chevron');
    const hiddenInput = dropdown.querySelector('input[name="region"]'); // if exists
    

    dropdown.addEventListener('mouseenter', function() {
      if (!dropdown.classList.contains('show')) {
        dropdown.classList.add('hover-show');
      }
    });

    if (searchInput) {
  const list = dropdown.querySelector('.dropdown-menu'); 
   
  // Fetch meters when input is focused
  searchInput.addEventListener('focus', function () {
    console.log(list.getAttribute("aria-labelledby")); 
    var path = '' ; 
    if(list.getAttribute("aria-labelledby") == "deviceDropdown"){
      path = '/get-installed-meters'; 
    }else if(list.getAttribute("aria-labelledby") == "zoneDropdown"){
      path = '/get-zone';  
    }else if(list.getAttribute("aria-labelledby") == "stationDropdown"){
      path = '/get-station';
    }else if(list.getAttribute("aria-labelledby") == "dcuDropdown"){
      path = '/get-installed-dcu';  
    }else if(list.getAttribute("aria-labelledby") == "archivedDropdown"){
      path = '/get-archived-meter'; 
    }else if(list.getAttribute("aria-labelledby") == "installedDropdown"){
      path = '/get-installed-meters';
    }
    fetch(path)
      .then(response => response.json())
      .then(data => {
        list.innerHTML = ''; // clear old items
        console.log(data); 
        data.forEach(element => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.className = 'dropdown-item hoverable-item';
          a.href = '#';
          a.textContent = element;
          a.setAttribute('data-value', element);  
          li.appendChild(a);
          list.appendChild(li);
        });

        dropdown.classList.add('show');
        dropdown.classList.remove('hover-show');
      });
  });

  // Real-time filtering — delegate to input
  searchInput.addEventListener('input', function () {
    const term = this.value.toLowerCase();
    const dropdownItems = list.querySelectorAll('.dropdown-item');
    dropdownItems.forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(term) ? 'block' : 'none'; 
    });
  });

  // Item selection — event delegation
  list.addEventListener('click', function (e) {
    if (e.target && e.target.matches('.dropdown-item')) {
      if (searchInput) searchInput.value = e.target.textContent;
      dropdown.classList.remove('show');
      if (hiddenInput) hiddenInput.value = e.target.getAttribute('data-value');
      e.preventDefault();
    }
  });
}

    // Chevron rotation
    if (chevron) {
      chevron.style.transition = 'transform 0.2s ease';
    }

    dropdown.addEventListener('show.bs.dropdown', () => {
      if (chevron) chevron.style.transform = 'translateY(-50%) rotate(180deg)';
    });
    dropdown.addEventListener('hide.bs.dropdown', () => {
      if (chevron) chevron.style.transform = 'translateY(-50%) rotate(0deg)';
    });

    // Close when clicking outside
    document.addEventListener('click', function(e) {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('show'); 
      }
    });
  });
});
</script>

{% endblock %} 