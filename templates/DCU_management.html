{% extends "base.html" %}
{% block content %}

{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %} 
<div class="p-4">
  <h2 class="mb-4">üî• DCU Management</h2>

  <form method = "GET" action = "/search-dcu" class="row g-2 mb-3">
    <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <div class="dropdown-toggle-wrapper position-relative">
          <input type="text" 
                 class="form-control dropdown-search-input dimmed-text hoverable-input" 
                 name="meter_number"
                 placeholder="DCU —Ö–∞–π—Ö"
                 value="{{ meter_number | default('') }}"
                 style="height: 33px; border-radius: 2px !important; padding-right: 30px;">
        </div>
      </div>
    </div>
    <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <div class="dropdown-toggle-wrapper position-relative">
          <select 
              class="form-select dropdown-search-input dimmed-text hoverable-input"
              style="height: 33px; border-radius: 2px !important; padding-right: 30px;"> 
            <option>status</option>
            <option>istalled</option>
            <option>archived</option>
          </select>
        </div>
      </div>
    </div>
        <div class="col-md-auto" style="width: 20%; min-height: 35px; height: auto;"> 
      <div class="dropdown" style="height: 35px;">
        <div class="dropdown-toggle-wrapper position-relative">
          <select 
              class="form-select dropdown-search-input dimmed-text hoverable-input"
              style="height: 33px; border-radius: 2px !important; padding-right: 30px;"> 
            <option>type</option>
            <option>DCU</option>
          </select>
        </div>
      </div>
    </div>
    <div class="col-md-auto" style="width: 4.166666%;">
      <button type="submit" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" > 
        <i class="bi bi-search"></i> 
      </button>
    </div>
    

    <div class="col-md-auto" style="width: 4.166666%;"> 
        <button type="button" class="btn btn-light w-100 border dimmed-text" style="height: 33px; border-radius: 2px" data-bs-toggle="modal" data-bs-target="#addMeterModal">
          <i class="bi bi-plus-lg"></i>
        </button>
    </div>
  </form>

  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>DCU No.</th>
        <th>Comm Addr</th>
        <th>remarks</th>
        <th>Create By</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for dcu in registered_dcus %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ dcu['dcu_number'] }}</td> 
        <td>{{ dcu['com_address'] }}</td>
        <td>{{ dcu['remarks'] or '-' }}</td>
        <td>{{ dcu['created_by'] }}</td> 
        <td>
          {% if dcu['status'] == 'Installed' %}
            <span class="badge bg-warning text-dark">Installed</span>
          {% elif dcu['status'] == 'Archived' %}
            <span class="badge bg-secondary">Archived</span>
          {% else %}
            <span class="badge bg-light text-muted">Unknown</span>
          {% endif %}
        </td>
        <td>
          <button class="btn btn-sm btn-secondary" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editDCUModal" 
                  data-original-dcu-number="{{dcu['dcu_number']}}"  
                  data-dcu-number="{{dcu['dcu_number']}}"
                  data-comm-address="{{ dcu['com_address'] }}"
                  data-password="{{ dcu['password'] }}"
                  data-remarks="{{ dcu['remarks'] }}"
                  data-status="{{ dcu['status'] }}">  
            <i class="bi bi-pencil-square"> Edit</i>
          </button> 
          <form method="POST" action="/delete-dcu" style="display:inline;" onsubmit="return confirmDelete();">  
            <input type="hidden" name="dcu_number" value="{{ dcu['dcu_number'] }}"> 
            <button type="submit" class="btn btn-sm btn-danger">
              <i class="bi bi-trash"> Delete</i>
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- add button form for meter adding  -->
 

<div class="modal fade" id="addDCUModal" tabindex="-1" aria-labelledby="addDCUModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addDCUModalLabel">Add DCU</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addDCUForm" method = "Post" action = "/add-dcu">   
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety-tab" data-bs-toggle="tab" data-bs-target="#safety" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail" role="tabpanel">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select" name="device_type"  required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>* DCU No.</label>
                    <input type="text" name="dcu_number" class="form-control" required> 
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>* Type</label>
                    <select class="form-select" name="type" required> 
                      <option>DDSY283SR</option>
                      <option>DTSD545S</option> 
                      
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Status</label>
                    <input type="text" name="status" class="form-control"  value="Archived" readonly> 
                  </div>
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" class="form-control">
                  </div>
                </div>
  
  
              
            </div>
  
            <div class="tab-pane fade" id="safety" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" class="form-control" required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="addDCUForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

  

  <!-- edit meter form for meter edit --> 
  <div class="modal fade" id="editDCUModal" tabindex="-1" aria-labelledby="editDCULabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addDCUModalLabel">Edit DCU</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editDCUForm" method = "Post" action = "/edit-dcu">   
            <input type="hidden" name="original_dcu_number" id="OriginalDCUNumber">  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail1-tab" data-bs-toggle="tab" data-bs-target="#detail1" type="button" role="tab">Detail</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="safety1-tab" data-bs-toggle="tab" data-bs-target="#safety1" type="button" role="tab">Safety</button>
            </li>
          </ul>
  
          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="detail1" role="tabpanel">
              
   
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Device Type</label>
                    <select class="form-select" name="device_type" id = "editDeviceType" required> 
                      <option>GPRS Meter</option>
                      <option>PLC Meter</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>* Meter No.</label>
                    <input type="text" name="dcu_number" id = "editDCUNumber" class="form-control" required> 
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>* Comm Addr</label>
                    <input type="text" name="comm_address" id = "editCommAddress" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>* Type</label>
                    <select class="form-select" name="type" id = "editType" required> 
                      <option>DDSY283SR</option>
                      <option>DTSD545S</option> 
                      
                    </select>
                  </div>
                </div>
  
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label>Status</label>
                    <input type="text" name="status" class="form-control"  value="Archived" readonly> 
                  </div>
                  <div class="col-md-6">
                    <label>Remarks</label>
                    <input type="text" name = "remarks" id = "editRemarks" class="form-control">
                  </div>
                </div>
  
  
              
            </div>
  
            <div class="tab-pane fade" id="safety1" role="tabpanel">
                <label>Password</label> 
                <input type="text" name="password" id = "editPassword" class="form-control" required>
            </div>
          </div>
        </form>
  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="editDCUForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>
 
  <script>
    const editModal = document.getElementById('editDCUModal');
    editModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;

      document.getElementById('OriginalDCUNumber').value = button.getAttribute('data-dcu-number'); 
      document.getElementById('editDCUNumber').value = button.getAttribute('data-dcu-number');
      document.getElementById('editCommAddress').value = button.getAttribute('data-comm-address');
      document.getElementById('editPassword').value = button.getAttribute('data-password');
      document.getElementById('editRemarks').value = button.getAttribute('data-remarks');
    });
    function confirmDelete(){
      return confirm("‚ö†Ô∏è Are you sure you want to delete this DCU?");
    }
  </script>


{% endblock %}
